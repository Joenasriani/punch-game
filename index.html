<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Smudger - Stress Buster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #ffffff;
            color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        #game-wrapper {
            position: relative;
            max-width: 95vw;
            margin: 20px auto;
            display: none;
            cursor: none;
        }
        canvas {
            border: 4px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 100%;
            height: auto;
            background-color: #f3f4f6;
            image-rendering: auto;
        }
        .fist-cursor {
            position: fixed;
            width: 80px;
            height: 80px;
            pointer-events: none;
            z-index: 100;
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.05s;
        }
        .punching {
            transform: scale(0.6) translate(-15px, 15px);
        }
        #library {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            margin-bottom: 1.5rem;
            justify-content: center;
        }
        .thumb-btn {
            flex: 0 0 auto;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2px;
            position: relative;
        }
        .thumb-btn:hover {
            border-color: #6366f1;
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .thumb-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        #loading-indicator {
            display: none;
            color: #6366f1;
            font-weight: bold;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="flex flex-col items-center py-20 px-4 min-h-screen">

    <div class="text-center mb-10">
        <div class="text-4xl font-extrabold mb-3 text-indigo-600">SMUDGE PUNCHER 3000</div>
        <p class="text-indigo-400 text-xl font-medium">release your temper!</p>
    </div>

    <div id="library">
        <!-- Populated by JS -->
    </div>

    <div id="loading-indicator">PREPARING TARGET...</div>

    <div id="setup-screen" class="w-full max-md mb-8">
        <label class="flex flex-col items-center justify-center w-full h-16 cursor-pointer rounded-xl border-2 border-dashed border-gray-300 hover:bg-gray-100 transition">
            <p class="text-sm text-gray-500 font-semibold">or Upload Custom Victim</p>
            <input id="image-input" type="file" class="hidden" accept="image/*" />
        </label>
    </div>

    <div id="game-wrapper">
        <canvas id="game-canvas"></canvas>
    </div>

    <div id="controls" class="hidden mt-12 mb-20 flex flex-wrap justify-center gap-6">
        <button id="reset-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-10 py-3 rounded-full font-bold transition">Reset Face</button>
        <button id="save-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-3 rounded-full font-bold transition">Save Result</button>
    </div>

    <div id="custom-cursor" class="fist-cursor hidden">ðŸ‘Š</div>

    <audio id="punch-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        const imageInput = document.getElementById('image-input');
        const setupScreen = document.getElementById('setup-screen');
        const gameWrapper = document.getElementById('game-wrapper');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const controls = document.getElementById('controls');
        const customCursor = document.getElementById('custom-cursor');
        const punchSound = document.getElementById('punch-sound');
        const saveBtn = document.getElementById('save-btn');
        const resetBtn = document.getElementById('reset-btn');
        const libraryDiv = document.getElementById('library');
        const loadingIndicator = document.getElementById('loading-indicator');

        const PEOPLE = [
            { name: "TRUMP", url: "/img/trump.jpg" },
            { name: "BEZOS", url: "/img/bezos.jpg" },
            { name: "ELON", url: "/img/elon.jpg" },
            { name: "ZUCKERBERG", url: "/img/zuckerberg.jpg" },
            { name: "GATES", url: "/img/gates.jpg" },
            { name: "COOK", url: "/img/cook.jpg" },
            { name: "ALTMAN", url: "/img/altman.jpg" }
        ];

        let currentImgUrl = PEOPLE[0].url;

        function populateLibrary() {
            libraryDiv.innerHTML = '';
            PEOPLE.forEach(person => {
                const btn = document.createElement('div');
                btn.className = 'thumb-btn';
                btn.title = person.name;

                const img = document.createElement('img');
                img.src = person.url;
                img.alt = person.name;
                img.onerror = () => {
                    img.style.display = 'none';
                    const span = document.createElement('span');
                    span.className = 'text-[10px] font-bold text-gray-400 uppercase tracking-tighter';
                    span.innerText = person.name;
                    btn.appendChild(span);
                };

                btn.appendChild(img);
                btn.onclick = () => {
                    currentImgUrl = person.url;
                    initGameWithImage(person.url);
                };
                libraryDiv.appendChild(btn);
            });
        }

        function initGameWithImage(imgSrc) {
            loadingIndicator.style.display = 'block';
            gameWrapper.style.display = 'none';
            controls.classList.add('hidden');

            const img = new Image();
            img.onload = function() {
                loadingIndicator.style.display = 'none';
                const maxW = window.innerWidth * 0.95;
                const maxH = window.innerHeight * 0.65;
                let scale = Math.min(maxW / img.width, maxH / img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                gameWrapper.style.display = 'block';
                controls.classList.remove('hidden');
                customCursor.classList.remove('hidden');
            };
            img.onerror = () => {
                loadingIndicator.style.display = 'none';
                console.warn("Local image not found at: " + imgSrc);
            };
            img.src = imgSrc;
        }

        window.onload = () => {
            populateLibrary();
            initGameWithImage(currentImgUrl);
        };

        resetBtn.onclick = () => initGameWithImage(currentImgUrl);

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                currentImgUrl = event.target.result;
                initGameWithImage(currentImgUrl);
            };
            reader.readAsDataURL(file);
        });

        window.addEventListener('mousemove', (e) => {
            customCursor.style.left = (e.clientX - 40) + 'px';
            customCursor.style.top = (e.clientY - 40) + 'px';
        });

        saveBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = 'punched-result.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        function applyHighResSmudge(cx, cy) {
            const radius = 100;
            const strength = 0.45;
            
            const startX = Math.max(0, Math.floor(cx - radius));
            const startY = Math.max(0, Math.floor(cy - radius));
            const endX = Math.min(canvas.width, Math.ceil(cx + radius));
            const endY = Math.min(canvas.height, Math.ceil(cy + radius));
            const width = endX - startX;
            const height = endY - startY;

            if (width <= 0 || height <= 0) return;

            const imageData = ctx.getImageData(startX, startY, width, height);
            const data = imageData.data;
            const copy = new Uint8ClampedArray(data);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const dx = (startX + x) - cx;
                    const dy = (startY + y) - cy;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < radius) {
                        const normDist = distance / radius;
                        const displacement = strength * Math.sin(Math.PI * normDist);
                        const amount = normDist + displacement;
                        
                        const srcX = (dx * (amount / normDist)) + radius - (startX - (cx - radius));
                        const srcY = (dy * (amount / normDist)) + radius - (startY - (cy - radius));
                        
                        const sx = Math.floor(Math.max(0, Math.min(width - 1, srcX)));
                        const sy = Math.floor(Math.max(0, Math.min(height - 1, srcY)));
                        
                        const si = (sy * width + sx) * 4;
                        const di = (y * width + x) * 4;
                        
                        data[di] = copy[si];
                        data[di+1] = copy[si+1];
                        data[di+2] = copy[si+2];
                        data[di+3] = copy[si+3];
                    }
                }
            }
            ctx.putImageData(imageData, startX, startY);

            const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
            grad.addColorStop(0, 'rgba(0, 0, 0, 0.12)');
            grad.addColorStop(0.5, 'rgba(0, 0, 0, 0.04)');
            grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.fill();
        }

        function handlePunch(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const canvasX = (clientX - rect.left) * (canvas.width / rect.width);
            const canvasY = (clientY - rect.top) * (canvas.height / rect.height);
            
            if (canvasX < 0 || canvasX > canvas.width || canvasY < 0 || canvasY > canvas.height) return;
            
            customCursor.classList.add('punching');
            setTimeout(() => customCursor.classList.remove('punching'), 100);
            
            punchSound.currentTime = 0;
            punchSound.play().catch(() => {});
            
            applyHighResSmudge(canvasX, canvasY);
            
            document.body.style.transform = `translate(${Math.random() * 8 - 4}px, ${Math.random() * 8 - 4}px)`;
            setTimeout(() => document.body.style.transform = 'none', 50);
        }

        canvas.addEventListener('mousedown', (e) => handlePunch(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            handlePunch(touch.clientX, touch.clientY);
        }, { passive: false });
    </script>
</body>
</html>
